<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project View - Khademul Portfolio</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: {} } };
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- AOS Animations -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js" defer></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- Custom Styles -->
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="min-h-screen flex flex-col font-poppins bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <!-- Header -->
  <div id="header"></div>

  <!-- Main Content -->
  <main class="flex-grow pt-24">
    <!-- Hero Section -->
    <div id="hero-container"></div>

    <div id="project-container" class="mx-auto container">
      <p id="status" class="text-center text-gray-500 mt-10">Loading project...</p>
    </div>

    <!-- Contact Form -->
    <div id="contact" class="mt-2 bg-gray-200 dark:bg-gray-800"></div>
  </main>

  <!-- Footer -->
  <div id="footer"></div>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
    <span id="lightbox-close" class="absolute top-4 right-6 text-red-600 text-3xl cursor-pointer">&times;</span>
    <img id="lightbox-img" src="" class="max-h-full max-w-full rounded shadow-lg transition-transform duration-300">
    <button onclick="prevLightboxImage()" class="absolute left-4 text-red-600 text-3xl top-1/2 -translate-y-1/2">&#10094;</button>
    <button onclick="nextLightboxImage()" class="absolute right-4 text-red-600 text-3xl top-1/2 -translate-y-1/2">&#10095;</button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------------- Supabase Setup ----------------
    const SUPABASE_URL = 'https://alvsikeqnudebronhzym.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsdnNpa2VxbnVkZWJyb25oenltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTA3NDUsImV4cCI6MjA3ODI2Njc0NX0.VveUI3DRSSWxrkQMoOBeQ9Vyov3EbPdFMDeBpM-w7yM'; // replace with your anon key
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const container = document.getElementById('project-container');
    const statusEl = document.getElementById('status');
    const projectId = new URLSearchParams(window.location.search).get('id');

    window.projectImages = [];
    window.currentIndex = 0;

    if (!projectId) {
      container.innerHTML = `<p class="text-red-500 text-center mt-10">No project found in provided URL.</p>`;
    } else {
      loadProject(projectId);
    }

    async function loadProject(id) {
      statusEl.textContent = "Loading project...";
      try {
        const { data: project, error } = await db
          .from('projects')
          .select(`*, project_images:project_images(*)`)
          .eq('id', id)
          .single();

        if (error) throw error;

        window.projectImages = project.project_images || [];
        currentIndex = 0;

          // ---------------- Hero ----------------
          const heroHTML = `
          <section class="project project1 project-hero text-white py-16 md:py-24 bg-indigo-600 dark:bg-indigo-800 w-full">
            <div class="px-6 md:px-12 lg:px-24">
              <a href="projects.html" class="inline-flex items-center text-white opacity-90 hover:opacity-100 mb-6 transition-opacity">
                <i class="fas fa-arrow-left mr-2"></i>
                <span>Back to Projects</span>
              </a>
              <h1 class="text-4xl md:text-5xl font-bold mb-4 animate-fade-in">${project.title}</h1>
              <p class="text-xl max-w-3xl opacity-90 animate-fade-in">${project.description}</p>
            </div>
          </section>
          `;
        // ---------------- Main Image ----------------
        const mainImageHTML = `
          <div class="mb-6 relative">
            <img id="mainImage" src="${project.image || 'https://placehold.co/800x400?text=No+Image'}" 
                 alt="Main Project Image" 
                 class="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg transition-transform duration-500">
          </div>
        `;

        // ---------------- Gallery ----------------
        const galleryHTML = window.projectImages.length
          ? window.projectImages.map((img, index) => `
            <div class="rounded-lg overflow-hidden shadow-md gallery-item cursor-pointer relative group">
              <img src="${img.image}" 
                   class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105 lazyload" 
                   data-index="${index}" 
                   alt="Project Image ${index + 1}">


            </div>
          `).join('')
          : `<p class="text-gray-500 col-span-3 text-center">No images for this project.</p>`;

        // ---------------- Sidebar ----------------
        const sidebarHTML = `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md sticky top-24">
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Project Details</h2>
            <div class="mb-6">
              <h3 class="font-semibold text-gray-700 dark:text-gray-300">Client</h3>
              <p class="text-gray-600 dark:text-gray-400">${project.client || 'Personal Project'}</p>
            </div>
            <div class="mb-6">
              <h3 class="font-semibold text-gray-700 dark:text-gray-300">Timeline</h3>
              <p class="text-gray-600 dark:text-gray-400">${project.timeline || 'N/A'}</p>
            </div>
            <div class="mb-6">
              <h3 class="font-semibold text-gray-700 dark:text-gray-300">Role</h3>
              <p class="text-gray-600 dark:text-gray-400">${project.role || 'Full-Stack Developer'}</p>
            </div>
            <div class="mb-8">
              <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Technologies</h3>
              <div class="flex flex-wrap gap-2">
                ${(project.tags || 'HTML,CSS,JS').split(',').map(t => `
                  <span class="bg-indigo-100 dark:bg-indigo-700 text-indigo-800 dark:text-indigo-100 px-3 py-1 rounded-full text-sm">${t.trim()}</span>
                `).join('')}
              </div>
            </div>
            <div class="flex flex-col space-y-3">
              <a href="${project.live_link || '#'}" target="_blank" class="bg-indigo-600 text-white text-center py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                <i class="fas fa-external-link-alt mr-2"></i>Live Demo
              </a>
              <a href="${project.github || '#'}" target="_blank" class="border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 text-center py-3 rounded-lg font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                <i class="fab fa-github mr-2"></i>View Code
              </a>
            </div>
          </div>
        `;

        // ---------------- Main Content ----------------
        const mainHTML = `
          <section class="project-details py-4">
            <div class="container mx-auto px-4">
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
                <!-- Main Content -->
                <div class="lg:col-span-2">
                  ${mainImageHTML}
                  <div class="mb-12">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">Project Overview</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">${project.description}</p>
                  </div>
                  <div class="mb-12">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">Project Gallery</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">${galleryHTML}</div>
                  </div>
                </div>
                <!-- Sidebar -->
                <div>${sidebarHTML}</div>
              </div>
            </div>
          </section>
        `;
          // Insert hero section
          document.getElementById('hero-container').innerHTML = heroHTML;

          // Insert main project details
          document.getElementById('project-container').innerHTML = mainHTML;
      } catch(err) {
        console.error(err);
        container.innerHTML = `<p class="text-red-500 text-center">Failed to load project.</p>`;
      }
    }

// ---------------- Load Header/Footer & Initialize Theme ----------------
async function loadHTML(id, file) {
  try {
    const res = await fetch(file);
    const html = await res.text();
    document.getElementById(id).innerHTML = html;
  } catch(err) {
    console.error(`${file} load error:`, err);
  }
}

// Load header first, then initialize theme
loadHTML('header', 'include/header.html').then(() => {
  const htmlEl = document.documentElement;
  const themeBtn = document.getElementById('theme-toggle');
  const moonIcon = document.getElementById('moon-icon');
  const sunIcon = document.getElementById('sun-icon');

  // Set initial theme based on localStorage
  if(localStorage.getItem('theme') === 'dark') {
    htmlEl.classList.add('dark');
  }

  function updateIcons() {
    if(htmlEl.classList.contains('dark')){
      moonIcon?.classList.remove('hidden');
      sunIcon?.classList.add('hidden');
    } else {
      moonIcon?.classList.add('hidden');
      sunIcon?.classList.remove('hidden');
    }
  }
  updateIcons();

  // Theme toggle button
  themeBtn?.addEventListener('click', () => {
    htmlEl.classList.toggle('dark');
    localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light');
    updateIcons();
  });
});

// Load footer independently
loadHTML('footer', 'include/footer.html');


  </script>

  <!-- Gallery + Lightbox -->
  <script>
    function setMainImage(index){
      currentIndex = index;
      document.getElementById('mainImage').src = projectImages[index].image;
    }
    function nextImage(){
      if(projectImages.length === 0) return;
      currentIndex = (currentIndex + 1) % projectImages.length;
      document.getElementById('mainImage').src = projectImages[currentIndex].image;
    }
    function prevImage(){
      if(projectImages.length === 0) return;
      currentIndex = (currentIndex - 1 + projectImages.length) % projectImages.length;
      document.getElementById('mainImage').src = projectImages[currentIndex].image;
    }

    // Lightbox
    document.addEventListener('click', (e)=>{
      if(e.target.closest('.gallery-item img')){
        const img = e.target;
        currentIndex = parseInt(img.dataset.index);
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        lightboxImg.src = projectImages[currentIndex].image;
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
      }
    });

    document.getElementById('lightbox-close').addEventListener('click', closeLightbox);
    document.getElementById('lightbox').addEventListener('click', e => {
      if(e.target.id === 'lightbox') closeLightbox();
    });

    function closeLightbox(){
      const lightbox = document.getElementById('lightbox');
      lightbox.classList.add('hidden');
      lightbox.classList.remove('flex');
    }

    document.addEventListener('keydown', e => {
      if(document.getElementById('lightbox').classList.contains('flex')){
        if(e.key==='ArrowRight') nextLightboxImage();
        if(e.key==='ArrowLeft') prevLightboxImage();
        if(e.key==='Escape') closeLightbox();
      }
    });
    function nextLightboxImage(){ currentIndex=(currentIndex+1)%projectImages.length; document.getElementById('lightbox-img').src = projectImages[currentIndex].image;}
    function prevLightboxImage(){ currentIndex=(currentIndex-1+projectImages.length)%projectImages.length; document.getElementById('lightbox-img').src = projectImages[currentIndex].image;}
  </script>

  <!-- Contact Form + EmailJS -->
  <script>
    async function initContactForm(){
      const section = document.getElementById('contact');
      const res = await fetch('contact.html'); // your contact form HTML
      section.innerHTML = await res.text();

      emailjs.init('0PfCUdQGydg8YIyMa'); // YOUR_EMAILJS_PUBLIC_KEY

      const form = document.getElementById('contactForm');
      if(form){
        form.addEventListener('submit', async e=>{
          e.preventDefault();
          const name = form.name.value;
          const email = form.email.value;
          const subject = form.subject.value;
          const message = form.message.value;

          // 1️⃣ Save to Supabase
          const { error } = await db.from('messages').insert([{ name,email,subject,message }]);
          if(error){ alert('❌ Error saving message: '+error.message); return; }

          // 2️⃣ Send emails via EmailJS
          const params = { name, email, subject, message, time: new Date().toLocaleString() };
          try{
            // To Admin
            await emailjs.send('service_yxru6db','template_cogdtl9',params);
            // To User
            await emailjs.send('service_yxru6db','template_lpxs3fp',params);

            alert('✅ Message sent successfully!');
            form.reset();
          }catch(err){
            console.error(err);
            alert('⚠️ Failed to send email.');
          }
        });
      }
    }
    initContactForm();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{if(window.AOS) AOS.init();});
  </script>
</body>
</html>
